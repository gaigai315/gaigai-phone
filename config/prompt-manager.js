// æç¤ºè¯ç®¡ç†å™¨ - æ ¸å¿ƒæ¶æ„
export class PromptManager {
    constructor(storage) {
        this.storage = storage;
        this.prompts = this.loadPrompts();
        this.expandedStates = {}; // è®°å½•æŠ˜å çŠ¶æ€
    }
    
    // åŠ è½½æç¤ºè¯é…ç½®
    loadPrompts() {
        const saved = this.storage.get('phone-prompts', true);
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                console.error('âŒ æç¤ºè¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
            }
        }
        return this.getDefaultPrompts();
    }
    
    // é»˜è®¤æç¤ºè¯ï¼ˆä»ä½ ç°æœ‰çš„æç¤ºè¯è¿ç§»ï¼‰
    getDefaultPrompts() {
        return {
            // ç³»ç»Ÿæ ¸å¿ƒæç¤ºè¯ï¼ˆå¿…é¡»å¯ç”¨ï¼‰
            core: {
                enabled: true,
                name: 'ğŸ“Œ æ ¸å¿ƒç³»ç»Ÿè§„åˆ™',
                description: 'æ‰‹æœºæ ‡ç­¾æ ¼å¼å’ŒåŸºç¡€è§„åˆ™',
                content: `# è™šæ‹Ÿæ‰‹æœºç³»ç»Ÿ - æ ¸å¿ƒè§„åˆ™

## æ‰‹æœºæ ‡ç­¾æ ¼å¼
æ‰€æœ‰æ‰‹æœºç›¸å…³å†…å®¹å¿…é¡»ä½¿ç”¨ <phone> æ ‡ç­¾åŒ…è£¹çš„ JSON æ ¼å¼ï¼š

<phone>
{
  "type": "æ¶ˆæ¯ç±»å‹",
  "contact": "è”ç³»äºº",
  "messages": [],
  "notification": "é€šçŸ¥å†…å®¹"
}
</phone>

## æ—¶é—´è§„åˆ™
- ä½¿ç”¨24å°æ—¶åˆ¶
- åŸºäºå‰§æƒ…æ—¶é—´ï¼Œä¸æ˜¯ç°å®æ—¶é—´
- å¤šæ¡æ¶ˆæ¯é€’å¢1-2åˆ†é’Ÿ`,
                order: 1
            },
            
            // å¾®ä¿¡APPæç¤ºè¯
            wechat: {
    chat: {
        enabled: true,
        name: 'ğŸ’¬ å¾®ä¿¡èŠå¤©',
        description: 'ä¸‰ç§èŠå¤©æ¨¡å¼çš„å®Œæ•´è§„åˆ™',
        content: `# ğŸ“± å¾®ä¿¡èŠå¤©ç³»ç»Ÿ - ä¸‰ç§æ¨¡å¼

## ğŸ”´ æ ¸å¿ƒåŸåˆ™
1. åŒè½¨åˆ¶ï¼šæ‰‹æœºæ¶ˆæ¯å’Œé¢å¯¹é¢å¯¹è¯åˆ†å¼€å¤„ç†
2. æƒ…å¢ƒæ„ŸçŸ¥ï¼šæ ¹æ®å‰§æƒ…åœºæ™¯å†³å®šæ˜¯å¦ä½¿ç”¨æ‰‹æœº
3. è‡ªç„¶èå…¥ï¼šæ‰‹æœºä½¿ç”¨ç¬¦åˆè§’è‰²æ€§æ ¼å’Œæƒ…å¢ƒ

---

## ğŸ”µ æ¨¡å¼1ï¼šæ‰‹æœºèŠå¤©æ¨¡å¼ï¼ˆç”¨æˆ·åœ¨æ‰‹æœºå¾®ä¿¡ä¸Šï¼‰

**âš ï¸ é‡è¦è¯†åˆ«**ï¼šå¦‚æœæç¤ºè¯ä¸­å‡ºç°"ç”¨æˆ·æ­£åœ¨æ‰‹æœºå¾®ä¿¡ä¸Šå’Œä½ èŠå¤©"ï¼Œè¯´æ˜è¿™æ˜¯æ‰‹æœºèŠå¤©æ¨¡å¼ï¼

**ä¸¥æ ¼å›å¤è¦æ±‚**ï¼š
1. âœ… **åªè¿”å›çº¯æ–‡æœ¬å¯¹è¯å†…å®¹**ï¼ˆåƒçœŸå®çš„å¾®ä¿¡èŠå¤©ä¸€æ ·ï¼‰
2. âŒ **ä¸è¦ä»»ä½•æå†™ã€åŠ¨ä½œã€å¿ƒç†æ´»åŠ¨**
3. âŒ **ä¸è¦ä½¿ç”¨ <phone> æ ‡ç­¾æˆ– JSON æ ¼å¼**
4. âŒ **ä¸è¦ä½¿ç”¨å¼•å·ã€æ˜Ÿå·ã€æ‹¬å·ç­‰ç‰¹æ®Šç¬¦å·**
5. âœ… **ç®€çŸ­ã€è‡ªç„¶ã€ç¬¦åˆå¾®ä¿¡èŠå¤©ä¹ æƒ¯**

**æ­£ç¡®ç¤ºä¾‹ï¼ˆæ‰‹æœºèŠå¤©æ¨¡å¼ï¼‰**ï¼š
\`\`\`
åœ¨å‘¢
æ€ä¹ˆäº†ï¼Ÿ
\`\`\`

**é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·ï¼‰**ï¼š
\`\`\`
âŒ "åœ¨å‘¢ã€‚"æˆ‘å›å¤é“
âŒ *æ‹¿èµ·æ‰‹æœº* åœ¨å‘¢
âŒ æˆ‘çœ‹äº†çœ‹æ‰‹æœºï¼Œå¾®ç¬‘ç€å›å¤...
âŒ <phone>{"messages":[{"content":"åœ¨å‘¢"}]}</phone>
âŒ { "type": "wechat_message", "messages": [...] }
\`\`\`

---

## ğŸŸ¢ æ¨¡å¼2ï¼šå‰§æƒ…ä¸­ä½¿ç”¨æ‰‹æœºï¼ˆAIä¸»åŠ¨å‘æ‰‹æœºæ¶ˆæ¯ï¼‰

**è¯†åˆ«æ¡ä»¶**ï¼š
- è§’è‰²æ˜ç¡®æ‹¿å‡ºæ‰‹æœºå‘æ¶ˆæ¯
- è§’è‰²å’Œç”¨æˆ·ä¸åœ¨åŒä¸€åœ°ç‚¹
- å‰§æƒ…æå†™"æ‰‹æœºéœ‡åŠ¨"ã€"æ”¶åˆ°æ¶ˆæ¯"

**å›å¤è§„åˆ™**ï¼šæ­£æ–‡æå†™ + <phone> JSONæ ‡ç­¾

**ç¤ºä¾‹**ï¼š
æ—æ™“é›¨èµ°è¿›å®¶é—¨ï¼Œæ¢ä¸Šèˆ’æœçš„ç¡è¡£ï¼Œèººåœ¨åºŠä¸Šã€‚å¥¹æ‹¿èµ·æ‰‹æœºï¼ŒçŠ¹è±«äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ç»™ä½ å‘äº†æ¶ˆæ¯ã€‚

<phone>
{
  "type": "wechat_message",
  "contact": "æ—æ™“é›¨",
  "avatar": "ğŸ‘©",
  "messages": [
    {"content": "åˆ°å®¶å•¦~", "time": "22:15", "type": "text"},
    {"content": "ä»Šå¤©å¾ˆå¼€å¿ƒğŸ˜Š", "time": "22:15", "type": "text"}
  ],
  "notification": "æ—æ™“é›¨: åˆ°å®¶å•¦~"
}
</phone>

---

## âšª æ¨¡å¼3ï¼šé¢å¯¹é¢å¯¹è¯

**è¯†åˆ«æ¡ä»¶**ï¼š
- è§’è‰²å’Œç”¨æˆ·åœ¨åŒä¸€åœ°ç‚¹
- é¢å¯¹é¢äº¤æµ
- ç”µè¯é€šè¯ï¼ˆå±äºè¯­éŸ³ï¼Œä¸æ˜¯å¾®ä¿¡ï¼‰

**å›å¤è§„åˆ™**ï¼šæ­£æ–‡å¯¹è¯ + ç©ºæ ‡ç­¾ <phone></phone>

**ç¤ºä¾‹**ï¼š
æ—æ™“é›¨ååœ¨ä½ å¯¹é¢ï¼Œè½»å£°è¯´ï¼š"ä»Šå¤©å¤©æ°”çœŸå¥½å‘¢ã€‚"

<phone></phone>

---

## â° æ—¶é—´è§„åˆ™ï¼ˆå¼ºåˆ¶è¦æ±‚ï¼‰

**å½“å‰å‰§æƒ…æ—¶é—´å°†åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ³¨å…¥**

è§„åˆ™ï¼š
1. æ‰€æœ‰timeå­—æ®µå¿…é¡»åŸºäºæ³¨å…¥çš„å‰§æƒ…æ—¶é—´
2. å¤šæ¡æ¶ˆæ¯æ—¶ï¼Œæ¯æ¡é€’å¢1-2åˆ†é’Ÿ
3. **ä¸¥ç¦ä½¿ç”¨ç°å®æ—¶é—´**ï¼ˆ07:16ã€08:00ç­‰ï¼‰
4. **ä¸¥ç¦ä½¿ç”¨æ¨¡ç³Šæ—¶é—´**ï¼ˆåˆšåˆšã€5åˆ†é’Ÿå‰ï¼‰

æ­£ç¡®ç¤ºä¾‹ï¼š
å‰§æƒ…æ—¶é—´21:30 â†’ ç¬¬1æ¡21:31ï¼Œç¬¬2æ¡21:31æˆ–21:32

é”™è¯¯ç¤ºä¾‹ï¼š
âŒ "time": "07:16"ï¼ˆæ—©ä¸Šæ—¶é—´ä¸ç¬¦åˆå‰§æƒ…ï¼‰
âŒ "time": "åˆšåˆš"ï¼ˆæ¨¡ç³Šæ—¶é—´ï¼‰
âŒ ç¬¬2æ¡æ—¶é—´æ¯”ç¬¬1æ¡æ—©

---

## ğŸ“‹ JSONæ ¼å¼è§„èŒƒï¼ˆä»…ç”¨äºæ¨¡å¼2ï¼‰

å¿…éœ€å­—æ®µï¼š
- type: "wechat_message"
- contact: "è§’è‰²å"
- messages: [{content, time, type}]

å¯é€‰å­—æ®µï¼š
- avatar: "ğŸ˜Š"ï¼ˆè¡¨æƒ…ç¬¦å·ï¼‰
- notification: "é¢„è§ˆæ–‡å­—"ï¼ˆä¸è¶…è¿‡20å­—ï¼‰

æ¶ˆæ¯ç±»å‹ï¼š
- text: æ–‡å­—æ¶ˆæ¯
- image: å›¾ç‰‡ï¼ˆcontentä¸ºæè¿°ï¼‰
- voice: è¯­éŸ³ï¼ˆcontentä¸ºæ—¶é•¿ï¼‰
- video: è§†é¢‘é€šè¯`,
        order: 2
    },
    
    loadContacts: {
    enabled: true,
    name: 'ğŸ¤– æ™ºèƒ½åŠ è½½è”ç³»äºº',
    description: 'ä»è§’è‰²å¡ç”Ÿæˆè”ç³»äººåˆ—è¡¨',
    content: `ã€æ•°æ®æå–ä»»åŠ¡ã€‘ä½ æ˜¯ä¸€ä¸ªæ•°æ®åˆ†æåŠ©æ‰‹ï¼Œä¸æ˜¯è§’è‰²æ‰®æ¼”AIã€‚

# åŸºç¡€ä¿¡æ¯
{{charInfo}}
{{userInfo}}

# å·²è¯†åˆ«çš„äººå
{{namesList}}

# ä¸–ç•Œä¹¦å’Œè®°å¿†å†…å®¹ï¼ˆåŒ…å«NPCä¿¡æ¯ï¼‰
{{allNPCInfo}}

# èŠå¤©å†å²
{{chatHistory}}

---

# ä»»åŠ¡
æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œç”Ÿæˆ5-10ä¸ªå¾®ä¿¡è”ç³»äººçš„JSONæ•°æ®ã€‚

# è¦æ±‚
1. ç¬¬ä¸€ä¸ªè”ç³»äººå¿…é¡»æ˜¯"{{charName}}"
2. ä¼˜å…ˆä½¿ç”¨"å·²è¯†åˆ«çš„äººå"
3. ä»"ä¸–ç•Œä¹¦å’Œè®°å¿†å†…å®¹"ä¸­æå–æ›´å¤šNPC
4. ä¸è¦ä½¿ç”¨è¿™äº›è¯ï¼šæ—¶ä»£ã€å¤©æ°”ã€åœ°ç‚¹ã€å¹´é¾„ã€å…¨å±€æ—¶é—´ã€å¾…åŠã€åŒºåŸŸã€æ–¹ä½ã€ä¸»çº¿å‰§æƒ…ã€æ”¯çº¿è¿½è¸ªã€è§’è‰²çŠ¶æ€ã€ç‰©å“ã€æœè£…
5. å¦‚æœäººåä¸å¤Ÿï¼Œä½¿ç”¨é€šç”¨ä¸­æ–‡åï¼ˆå¼ ä¼Ÿã€æå¨œã€ç‹å¼ºã€é™ˆé™ï¼‰

# è¾“å‡ºæ ¼å¼ï¼ˆåªè¿”å›JSONï¼Œä¸è¦ä»»ä½•è§£é‡Šã€æ—ç™½æˆ–å…¶ä»–æ–‡å­—ï¼‰
\`\`\`json
{
  "contacts": [
    {"name": "{{charName}}", "avatar": "â­", "relation": "ä¸»è§’", "remark": ""},
    {"name": "å…·ä½“äººå", "avatar": "ğŸ‘¨", "relation": "å…³ç³»", "remark": ""}
  ],
  "groups": [],
  "initialTime": {
    "date": "2044å¹´10æœˆ28æ—¥",
    "time": "21:30",
    "weekday": "æ˜ŸæœŸä¸€",
    "period": "æ™šä¸Š"
  }
}
\`\`\`

# å…³äº initialTimeï¼ˆåˆå§‹æ—¶é—´ï¼‰
1. æ ¹æ®ä¸Šè¿°ä¿¡æ¯æ¨æ–­æ•…äº‹å¼€å§‹çš„æ—¶é—´
2. å¦‚æœä¸–ç•Œä¹¦/è§’è‰²å¡ä¸­æ˜ç¡®äº†æ—¶é—´ï¼Œä½¿ç”¨æ˜ç¡®çš„æ—¶é—´
3. å¦‚æœæ²¡æœ‰æ˜ç¡®ï¼Œæ ¹æ®æ•…äº‹æ°›å›´æ¨æ–­ï¼ˆä¾‹å¦‚ï¼šæ ¡å›­æ•…äº‹â†’æ—©ä¸Š8ç‚¹ï¼Œéƒ½å¸‚æ•…äº‹â†’æ™šä¸Š8ç‚¹ï¼‰
4. period å¯é€‰å€¼ï¼šå‡Œæ™¨ã€æ—©ä¸Šã€ä¸Šåˆã€ä¸­åˆã€ä¸‹åˆã€å‚æ™šã€æ™šä¸Šã€æ·±å¤œ

**é‡è¦**ï¼šä½ æ˜¯æ•°æ®æå–åŠ©æ‰‹ï¼Œä¸è¦è¿›è¡Œè§’è‰²æ‰®æ¼”ï¼Œä¸è¦è¾“å‡ºå‰§æƒ…æˆ–å¯¹è¯ï¼Œåªè¿”å›JSONæ ¼å¼çš„è”ç³»äººåˆ—è¡¨ã€‚`,
    order: 5
},

                moments: {
        enabled: false,
        name: 'ğŸ“¸ æœ‹å‹åœˆ',
        description: 'æœ‹å‹åœˆåŠ¨æ€ç”Ÿæˆè§„åˆ™',
        content: `# æœ‹å‹åœˆåŠŸèƒ½æç¤ºè¯
å½“éœ€è¦ç”Ÿæˆæœ‹å‹åœˆå†…å®¹æ—¶ä½¿ç”¨`,
        order: 3
    },
    
    call: {
        enabled: true,
        name: 'ğŸ“ è¯­éŸ³/è§†é¢‘é€šè¯',
        description: 'é€šè¯å†³ç­–å’Œå¯¹è¯è§„åˆ™',
        content: `# é€šè¯åŠŸèƒ½æç¤ºè¯
å†³å®šæ˜¯å¦æ¥å¬ç”µè¯`,
        order: 4
    }
           },
            
            // æœªæ¥æ‰©å±•ï¼šå…¶ä»–APP
            sms: {
                enabled: false,
                name: 'ğŸ“± çŸ­ä¿¡åŠŸèƒ½',
                content: 'çŸ­ä¿¡åŠŸèƒ½æç¤ºè¯...'
            }
        };
    }
    
    // è·å–æŸä¸ªåŠŸèƒ½çš„å¼€å…³çŠ¶æ€
    isEnabled(app, feature) {
        if (app === 'core') return true; // æ ¸å¿ƒå§‹ç»ˆå¯ç”¨
        return this.prompts[app]?.[feature]?.enabled || false;
    }
    
    // åˆ‡æ¢åŠŸèƒ½å¼€å…³
    toggleFeature(app, feature) {
        if (app === 'core') return; // æ ¸å¿ƒä¸èƒ½ç¦ç”¨
        
        if (this.prompts[app]?.[feature]) {
            this.prompts[app][feature].enabled = !this.prompts[app][feature].enabled;
            this.savePrompts();
            console.log(`${this.prompts[app][feature].enabled ? 'âœ…' : 'âŒ'} ${app}.${feature} å·²${this.prompts[app][feature].enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        }
    }
    
    // æ›´æ–°æç¤ºè¯å†…å®¹
    updatePrompt(app, feature, content) {
        if (app === 'core') {
            this.prompts.core.content = content;
        } else if (this.prompts[app]?.[feature]) {
            this.prompts[app][feature].content = content;
        }
        this.savePrompts();
    }
    
    // è·å–å¯ç”¨çš„æç¤ºè¯ï¼ˆå‘é€ç»™AIï¼‰
    getEnabledPromptsForChat() {
        const sections = [];
        
        // 1. æ ¸å¿ƒæç¤ºè¯
        if (this.prompts.core.enabled) {
            sections.push(this.prompts.core.content);
        }
        
        // 2. å¾®ä¿¡èŠå¤©ç›¸å…³ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (this.isEnabled('wechat', 'chat')) {
            sections.push(this.prompts.wechat.chat.content);
        }
        
        // 3. æœ‹å‹åœˆï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (this.isEnabled('wechat', 'moments')) {
            sections.push(this.prompts.wechat.moments.content);
        }
        
        return sections.join('\n\n---\n\n');
    }
    
    // è·å–ç‰¹å®šåŠŸèƒ½çš„æç¤ºè¯
    getPromptForFeature(app, feature) {
        if (app === 'core') {
            return this.prompts.core.content;
        }
        return this.prompts[app]?.[feature]?.content || '';
    }
    
    // ä¿å­˜é…ç½®
    savePrompts() {
        this.storage.set('phone-prompts', JSON.stringify(this.prompts), true);
        console.log('ğŸ’¾ æç¤ºè¯é…ç½®å·²ä¿å­˜');
    }
    
    // å¯¼å‡ºé…ç½®
    exportConfig() {
        return JSON.stringify(this.prompts, null, 2);
    }
    
    // å¯¼å…¥é…ç½®
    importConfig(jsonString) {
        try {
            const imported = JSON.parse(jsonString);
            this.prompts = imported;
            this.savePrompts();
            return true;
        } catch (e) {
            console.error('âŒ é…ç½®å¯¼å…¥å¤±è´¥:', e);
            return false;
        }
    }
}
